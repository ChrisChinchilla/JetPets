<?php

/**
 * @file
 * Short file description here.
 *
 * Long description here.
 */

/**
 * Implements hook_menu().
 */
function jpgf_menu() {

  $items['jpgf/import'] = array(
    'title' => 'Import GF JSON',
    'page callback' => 'jpgf_page',
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM,
    );

  return $items;
}

/**
 * Implements hook_help().
 */
function jpgf_help($path, $arg) {

  switch ($path) {
    case 'admin/help#jpgf':

      // Return a line-break version of the README.
    $readme = file_get_contents(drupal_get_path('module', 'jpgf') . '/README.txt');
    return nl2br($readme);
  }
}

/**
 * Page example callback, referenced in hook_menu().
 *
 * Description of what the page displays.
 * Second line of the description.
 *
 * @return string
 *   The content of the page.
 */
function jpgf_page() {
//This can all go after testing
  $output = process_json();
  dpm($output);
  return $output;

}

function process_json() {
  $context = stream_context_create(array(
   'http' => array(
    'method' => "GET",
    'header' => 'Authorization: Bearer 173709a1f841645f8f1a0e0991f37056'
    )
   ));

  $response =  file_get_contents('https://api.getfeedback.com/surveys/29880/responses', false, $context);

// Check for errors
  if($response === FALSE){
    // die(curl_error($ch));
  }

  else {

// Decode the response

    $responseData = json_decode($response, TRUE);
    $returnData = array();
    foreach ($responseData['active_models'] as $value) {
      if((!empty($value['answers'])) && ($value['status'] == 'completed')) {
       /*
       create a node object and add to watchdog
       We should check if the id already exists
        */
       $query = new EntityFieldQuery();
       $query->entityCondition('entity_type', 'node')
       ->entityCondition('bundle', 'survey_response')
       ->propertyCondition('status', 1)
       ->fieldCondition('field_gf_id', 'value', $value['id'], '=')
       ->range(0, 1)
          ->addMetaData('account', user_load(1)); // Run the query as user 1.

          $result = $query->execute();

          if (!isset($result['node'])) {
            // Create the Contact
            // If the Survey changes, this code will have to change
            // More of the contact fields need to be added to the GF Survey. Maybe?

            $cNode = new stdClass(); // We create a new node object
            $cNode->type = "contact"; // Or any other content type you want
            $cNode->title = $value['answers'][0]['form_fields'][1]['text'] . " " . $value['answers'][0]['form_fields'][2]['text'];
            $cNode->language = LANGUAGE_NONE; // Or any language code if Locale module is enabled. More on this below *
            //$node->path = array('alias' => 'your node path'); // Setting a node path
            $cNode->field_email[LANGUAGE_NONE][0]['email'] = $value['answers'][0]['form_fields'][3]['text'];
            node_object_prepare($cNode); // Set some default values.
            $cNode->uid = 1; // Or any id you wish

            $cNode = node_submit($cNode); // Prepare node for a submit
            node_save($cNode); // After this call we'll get a nid
            watchdog('jpgf', 'New Contact created with ID %nid', array('nid' => $cNode->nid), WATCHDOG_NOTICE);

            // Create the Pet
            // If the Survey changes, this code will have to change
            // More of the pet fields need to be added to the GF Survey. Maybe?

            $pNode = new stdClass(); // We create a new node object
            $pNode->type = "pet"; // Or any other content type you want
            $pNode->title = $value['answers'][0]['form_fields'][0]['text'];
            $pNode->language = LANGUAGE_NONE; // Or any language code if Locale module is enabled. More on this below *
            //$node->path = array('alias' => 'your node path'); // Setting a node path
            //Could the below be better, using taxonomy to allow for future expansion, but will it?
            $petSex = taxonomy_get_term_by_name($value['answers'][0]['form_fields'][4]['text'], 'pet_sex');
            if(!empty($petSex)) $pNode->field_pet_sex[LANGUAGE_NONE][0]['tid'] = key($petSex);
            $petType = taxonomy_get_term_by_name($value['answers'][11]['choices'][0]['text'], 'pet_type');
            if(!empty($petType)) $pNode->field_pet_type[LANGUAGE_NONE][0]['tid'] = key($petType);
            node_object_prepare($cNode); // Set some default values.
            $pNode->uid = 1; // Or any id you wish

            $pNode = node_submit($pNode); // Prepare node for a submit
            node_save($pNode); // After this call we'll get a nid
            watchdog('jpgf', 'New Pet created with ID %nid', array('nid' => $pNode->nid), WATCHDOG_NOTICE);


            //Create the Survey Response
            $srNode = new stdClass(); // We create a new node object
            $srNode->type = "survey_response"; // Or any other content type you want
            $srNode->title = $value['id'];
            $srNode->language = LANGUAGE_NONE; // Or any language code if Locale module is enabled. More on this below *
            //$node->path = array('alias' => 'your node path'); // Setting a node path
            node_object_prepare($srNode); // Set some default values.
            $srNode->uid = 1; // Or any id you wish
            $srNode->field_gf_id[LANGUAGE_NONE][0]['value'] = $value['id'];
            $srNode->field_contact[LANGUAGE_NONE][0]['target_id'] = $cNode->nid;
            $srNode->field_pet[LANGUAGE_NONE][0]['target_id'] = $pNode->nid;

            /* We have a bunch of field collection fields that hold a reference to each pet character and this response's score against each one. For now we are generating random numbers, later we will fill in the real processing.

            For that I suggest before entering the FC loop we build arrays of each chracter and score, sort (for top 2) then pass into matching fc values somehow */

            $query = new EntityFieldQuery();
            $query->entityCondition('entity_type', 'node')
            ->entityCondition('bundle', 'pet_character')
            ->propertyCondition('status', 1)
            ->range(0, 5);

            $result = $query->execute();

            if (isset($result['node'])) {
              $nids = array_keys($result['node']);
              $items = entity_load('node', $nids);
              foreach ($items as $key => $node) {
                // Create a new field collection
                $field_collection_item = entity_create('field_collection_item', array('field_name' => 'field_pet_characters'));

                // Load items into field collection
                $field_collection_item->field_linked_pet_character[LANGUAGE_NONE][$key]['target_id'] = $node->nid;
                $field_collection_item->field_linked_character_score[LANGUAGE_NONE][$key]['value'] = rand(0,10);

                // Save field collection item
                $field_collection_item->setHostEntity('node', $srNode);
                $field_collection_item->save(TRUE);
              }
            }

            $srNode = node_submit($srNode); // Prepare node for a submit
            node_save($srNode); // After this call we'll get a nid
            watchdog('jpgf', 'New Survey Response created with ID %nid', array('nid' => $value['id']), WATCHDOG_NOTICE);

            $returnData[] = $value; // This can probably go?
            //drupal_mail("example_module", "outgoing_message" ...)

            $params = array(
              'petName' => $pNode->title,
              'petType' => 'tbc',
              'image' => 'tbc'
              );

            $message = drupal_mail('jpgf', 'srprocesscomplete', $value['answers'][0]['form_fields'][3]['text'],LANGUAGE_NONE, $params);
            dpm($message);
          } else {
            watchdog('jpgf', 'Node based on this Survey Response has already been created',NULL, WATCHDOG_NOTICE);
          }
        }
      }
      //This can go after testing?
      return $returnData;
    }
  }

/**
 * Implements hook_page_build().
 *
 * Add JavaScript and CSS code to every page.
 */
function jpgf_page_build() {

  drupal_add_js(drupal_get_path('module', 'jpgf') . '/js/jpgf.js');
  drupal_add_css(drupal_get_path('module', 'jpgf') . '/css/jpgf.css');

}

function jpgf_cron() {
  process_json();
}
